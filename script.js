const boardWrap=document.getElementById('boardWrap');const newGameBtn=document.getElementById('newGame');const levelSel=document.getElementById('level');const minesLeftEl=document.getElementById('minesLeft');const statusEl=document.getElementById('status');const timerEl=document.getElementById('timer');const hintBtn=document.getElementById('hint');const bestTimesEl=document.getElementById('bestTimes');let rows=16,cols=16,minesCount=40;let grid=[];let boardEl=null;let started=false;let timer=null;let time=0;let flags=0;let revealedCount=0;let hintUses=3;const PRESETS={easy:{r:9,c:9,m:10},medium:{r:16,c:16,m:40},hard:{r:16,c:30,m:99}};function setStatus(text){statusEl.textContent=text}function setTimerText(){timerEl.textContent=`Time: ${time}s`}function setMinesLeft(){minesLeftEl.textContent=`Mines: ${Math.max(0,minesCount-flags)}`}function buildBoardDOM(){if(boardEl)boardEl.remove();boardEl=document.createElement('div');boardEl.className='board';boardEl.style.gridTemplateColumns=`repeat(${cols}, auto)`;boardEl.setAttribute('tabindex','0');grid=[];for(let r=0;r<rows;r++){for(let c=0;c<cols;c++){const cell={r,c,isMine:false,adj:0,revealed:false,flagged:false,element:document.createElement('button')};const el=cell.element;el.className='cell';el.setAttribute('data-r',r);el.setAttribute('data-c',c);el.setAttribute('aria-label',`Cell ${r+1}, ${c+1}`);el.addEventListener('click',onCellClick);el.addEventListener('contextmenu',onCellContext);boardEl.appendChild(el);grid.push(cell)}}boardWrap.appendChild(boardEl)}function cellAt(r,c){return grid[r*cols+c]}function placeMines(excludeR,excludeC){const safe=new Set();for(let dr=-1;dr<=1;dr++){for(let dc=-1;dc<=1;dc++){const rr=excludeR+dr,cc=excludeC+dc;if(rr>=0&&rr<rows&&cc>=0&&cc<cols)safe.add(rr*cols+cc)}}let toPlace=minesCount;while(toPlace>0){const r=Math.floor(Math.random()*rows);const c=Math.floor(Math.random()*cols);const idx=r*cols+c;if(safe.has(idx))continue;const cell=cellAt(r,c);if(cell.isMine)continue;cell.isMine=true;toPlace--}for(let r=0;r<rows;r++){for(let c=0;c<cols;c++){const cell=cellAt(r,c);if(cell.isMine){cell.adj=-1;continue}let count=0;for(let dr=-1;dr<=1;dr++){for(let dc=-1;dc<=1;dc++){if(dr===0&&dc===0)continue;const rr=r+dr,cc=c+dc;if(rr>=0&&rr<rows&&cc>=0&&cc<cols){if(cellAt(rr,cc).isMine)count++}}}cell.adj=count}}}function revealCell(cell){if(cell.revealed||cell.flagged)return;cell.revealed=true;revealedCount++;const el=cell.element;el.classList.add('revealed');if(cell.isMine){el.classList.add('mine');el.textContent='ðŸ’£';revealAllMines();gameOver(false);return}else if(cell.adj>0){el.textContent=String(cell.adj);el.classList.add('n'+cell.adj)}else{el.textContent='';for(let dr=-1;dr<=1;dr++){for(let dc=-1;dc<=1;dc++){if(dr===0&&dc===0)continue;const rr=cell.r+dr,cc=cell.c+dc;if(rr>=0&&rr<rows&&cc>=0&&cc<cols){revealCell(cellAt(rr,cc))}}}}checkWin()}function revealAllMines(){grid.forEach(cell=>{if(cell.isMine){cell.element.classList.add('revealed','mine');if(!cell.revealed)cell.element.textContent='ðŸ’£';cell.revealed=true}})}function toggleFlag(cell){if(cell.revealed)return;cell.flagged=!cell.flagged;cell.element.classList.toggle('flagged',cell.flagged);cell.element.textContent=cell.flagged?'ðŸš©':'';flags+=cell.flagged?1:-1;setMinesLeft()}function onCellClick(e){const el=e.currentTarget;const r=Number(el.dataset.r),c=Number(el.dataset.c);const cell=cellAt(r,c);if(!started){startGame(r,c)}revealCell(cell)}function onCellContext(e){e.preventDefault();const el=e.currentTarget;const r=Number(el.dataset.r),c=Number(el.dataset.c);const cell=cellAt(r,c);toggleFlag(cell)}function checkWin(){if(revealedCount===rows*cols-minesCount){revealAllMines();gameOver(true)}}function gameOver(won){stopTimer();started=false;hintBtn.disabled=true;if(won){setStatus(`You won in ${time}s!`);saveBestTime(levelSel.value,time);renderBestTimes()}else{setStatus('Boom! You hit a mine. Press New Game to try again.')}}function startTimer(){stopTimer();time=0;setTimerText();timer=setInterval(()=>{time++;setTimerText()},1000)}function stopTimer(){if(timer)clearInterval(timer);timer=null}function startGame(firstR,firstC){started=true;placeMines(firstR,firstC);startTimer();flags=0;revealedCount=0;hintUses=3;hintBtn.disabled=false;setMinesLeft();setStatus('Good luck!')}function newGame(){const preset=PRESETS[levelSel.value];rows=preset.r;cols=preset.c;minesCount=preset.m;buildBoardDOM();started=false;stopTimer();time=0;setTimerText();flags=0;revealedCount=0;setMinesLeft();hintUses=3;hintBtn.disabled=true;setStatus('Press a cell to start. Right-click to flag.');renderBestTimes()}function useHint(){if(!started)return setStatus('Start the game first to use a hint.');if(hintUses<=0)return setStatus('No hints left.');const candidates=grid.filter(c=>!c.revealed&&!c.isMine&&!c.flagged);if(candidates.length===0)return setStatus('No safe cells left to reveal.');const pick=candidates[Math.floor(Math.random()*candidates.length)];revealCell(pick);hintUses--;setStatus(`Hint used. ${hintUses} hint(s) left.`);if(hintUses<=0)hintBtn.disabled=true}function loadBestTimes(){try{const raw=localStorage.getItem('ms_best_times');if(raw)return JSON.parse(raw)}catch(e){}return{easy:null,medium:null,hard:null}}function saveBestTime(level,t){const times=loadBestTimes();const prev=times[level];if(prev===null||t<prev){times[level]=t;try{localStorage.setItem('ms_best_times',JSON.stringify(times))}catch(e){}setStatus(`New best time for ${level}: ${t}s`)}}function renderBestTimes(){const times=loadBestTimes();bestTimesEl.innerHTML='';['easy','medium','hard'].forEach(l=>{const li=document.createElement('li');li.textContent=`${l}: ${times[l]===null?'â€”':times[l]+'s'}`;bestTimesEl.appendChild(li)})}newGameBtn.addEventListener('click',newGame);levelSel.addEventListener('change',newGame);hintBtn.addEventListener('click',useHint);boardWrap.addEventListener('contextmenu',(e)=>{if(e.target&&e.target.classList.contains('cell'))e.preventDefault()});renderBestTimes();newGame();setStatus('Pick difficulty and press New Game.');
